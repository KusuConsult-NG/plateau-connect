<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plateau Connect</title>
  <link rel="icon" href="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%2300A591'/><stop offset='1' stop-color='%232eccb3'/></linearGradient></defs><rect width='128' height='128' rx='22' fill='url(%23g)'/><path d='M20 98 C 45 78, 60 72, 108 34' fill='none' stroke='%23fff' stroke-width='10' stroke-linecap='round'/><circle cx='24' cy='98' r='6' fill='%23F3A847'/><circle cx='108' cy='34' r='6' fill='%23E54F25'/><text x='28' y='60' font-size='44' font-weight='800' fill='%23ffffff' font-family='Inter, system-ui'>P</text><text x='64' y='94' font-size='44' font-weight='800' fill='%23ffffff' font-family='Inter, system-ui'>C</text></svg>"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root{--brand-green:#00A591;--brand-dark:#373D3F;}
    .btn{padding:.6rem 1rem;border-radius:.75rem;font-weight:700}
    .btn-primary{background:var(--brand-green);color:#fff}
    .card{background:#fff;border-radius:1rem;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:1rem}
  </style>
</head>
<body class="bg-gray-50">
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto p-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%2300A591'/><stop offset='1' stop-color='%232eccb3'/></linearGradient></defs><rect width='128' height='128' rx='22' fill='url(%23g)'/><path d='M20 98 C 45 78, 60 72, 108 34' fill='none' stroke='%23fff' stroke-width='10' stroke-linecap='round'/><circle cx='24' cy='98' r='6' fill='%23F3A847'/><circle cx='108' cy='34' r='6' fill='%23E54F25'/><text x='28' y='60' font-size='44' font-weight='800' fill='%23ffffff' font-family='Inter, system-ui'>P</text><text x='64' y='94' font-size='44' font-weight='800' fill='%23ffffff' font-family='Inter, system-ui'>C</text></svg>" alt="Plateau Connect" class="w-10 h-10 rounded-xl"/>
        <div class="text-xl font-extrabold text-[color:var(--brand-dark)]">Plateau<span class="text-[color:var(--brand-green)]">Connect</span></div>
      </div>
      <div class="flex items-center gap-2">
        <div class="hidden md:flex items-center gap-2 text-sm">
          <span>API:</span>
          <select id="apiMode" class="border rounded-xl p-1">
            <option value="local">Local Demo</option>
            <option value="live">Live Backend</option>
          </select>
          <input id="apiBase" class="border rounded-xl p-1 w-56" placeholder="https://api.yourdomain.com"/>
          <button id="saveApi" class="px-2 py-1 border rounded">Save</button>
        </div>
        <select id="roleSelect" class="border rounded-xl p-2">
          <option value="rider">Rider</option>
          <option value="driver">Driver</option>
          <option value="admin">Admin</option>
        </select>
        <button id="logoutBtn" class="px-3 py-2 rounded-xl border">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <div id="authView" class="hidden">
      <div class="max-w-md mx-auto card">
        <div class="flex justify-center mb-6">
          <img src="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'><defs><linearGradient id='g' x1='0' y='0' x2='1' y2='1'><stop offset='0' stop-color='%2300A591'/><stop offset='1' stop-color='%232eccb3'/></linearGradient></defs><rect width='128' height='128' rx='22' fill='url(%23g)'/><path d='M20 98 C 45 78, 60 72, 108 34' fill='none' stroke='%23fff' stroke-width='10' stroke-linecap='round'/><circle cx='24' cy='98' r='6' fill='%23F3A847'/><circle cx='108' cy='34' r='6' fill='%23E54F25'/><text x='28' y='60' font-size='44' font-weight='800' fill='%23ffffff' font-family='Inter, system-ui'>P</text><text x='64' y='94' font-size='44' font-weight='800' fill='%23ffffff' font-family='Inter, system-ui'>C</text></svg>" class="w-14 h-14 rounded-xl"/>
        </div>
        <h2 class="text-2xl font-bold text-[color:var(--brand-dark)] mb-4" id="authTitle">Sign in</h2>
        <div class="space-y-3">
          <input id="authName" class="w-full border rounded-xl p-3 hidden" placeholder="Full name"/>
          <input id="authEmail" class="w-full border rounded-xl p-3" placeholder="Email"/>
          <input id="authPassword" class="w-full border rounded-xl p-3" type="password" placeholder="Password"/>
          <button id="authSubmit" class="btn btn-primary w-full">Sign in</button>
        </div>
        <div class="text-sm mt-4 text-gray-600">
          <span id="authToggle">No account? <button class="text-[color:var(--brand-green)] font-semibold">Register</button></span>
        </div>
        <div class="mt-4 text-sm text-gray-500">
          Demo: admin@demo.local / admin123, rider@demo.local / rider123, driver@demo.local / driver123
        </div>
      </div>
    </div>

    <div id="appView" class="space-y-6">
      <section id="riderDash" class="hidden grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <div class="card">
            <h3 class="text-lg font-bold mb-4">Book a Trip</h3>
            <div class="grid md:grid-cols-3 gap-3">
              <select id="routeSelect" class="border rounded-xl p-3"></select>
              <select id="tripSelect" class="border rounded-xl p-3"></select>
              <input id="seatInput" class="border rounded-xl p-3" type="number" min="1" max="6" value="1"/>
            </div>
            <div class="mt-4 flex gap-2 flex-wrap text-sm">
              <span class="px-3 py-1 rounded-full bg-teal-100 text-teal-700 font-semibold">07:00</span>
              <span class="px-3 py-1 rounded-full bg-teal-100 text-teal-700 font-semibold">08:00</span>
              <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">10:00</span>
              <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">12:00</span>
              <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 font-semibold">14:00</span>
              <span class="px-3 py-1 rounded-full bg-teal-100 text-teal-700 font-semibold">15:00</span>
              <span class="px-3 py-1 rounded-full bg-teal-100 text-teal-700 font-semibold">16:00</span>
            </div>
            <button id="bookBtn" class="btn btn-primary mt-4">Confirm Booking</button>
          </div>
          <div class="card mt-6">
            <h3 class="text-lg font-bold mb-3">Pickup Stations</h3>
            <div id="map" class="h-80 rounded-xl overflow-hidden"></div>
          </div>
        </div>
        <div>
          <div class="card">
            <h3 class="text-lg font-bold mb-2">My Bookings</h3>
            <div id="myBookings" class="space-y-2 text-sm"></div>
          </div>
          <div class="card mt-6">
            <h3 class="text-lg font-bold mb-2">Alerts & Notifications</h3>
            <div id="alerts" class="text-sm text-gray-600">No new alerts</div>
          </div>
        </div>
      </section>

      <section id="driverDash" class="hidden grid gap-6">
        <div class="card">
          <h3 class="text-lg font-bold mb-2">My Assigned Trips</h3>
          <div id="driverTrips" class="text-sm text-gray-700"></div>
        </div>
        <div class="card">
          <h3 class="text-lg font-bold mb-2">Passenger Manifest</h3>
          <div class="flex gap-3">
            <select id="driverTripSelect" class="border rounded-xl p-2"></select>
            <button id="driverLoadManifest" class="border rounded-xl px-3">Load</button>
          </div>
          <div id="driverManifest" class="mt-3 text-sm"></div>
        </div>
      </section>

      <section id="adminDash" class="hidden grid lg:grid-cols-2 gap-6">
        <div class="card">
          <h3 class="text-lg font-bold mb-3">Create Route</h3>
          <div class="grid md:grid-cols-3 gap-3">
            <input id="routeName" class="border rounded-xl p-3" placeholder="Route name"/>
            <select id="fromStation" class="border rounded-xl p-3"></select>
            <select id="toStation" class="border rounded-xl p-3"></select>
          </div>
          <button id="saveRoute" class="btn btn-primary mt-3">Save Route</button>
        </div>

        <div class="card">
          <h3 class="text-lg font-bold mb-3">Create Trip</h3>
          <div class="grid md:grid-cols-4 gap-3">
            <select id="tripRoute" class="border rounded-xl p-3"></select>
            <select id="tripTime" class="border rounded-xl p-3">
              <option>07:00</option><option>08:00</option><option>10:00</option>
              <option>12:00</option><option>14:00</option><option>15:00</option><option>16:00</option>
            </select>
            <input id="tripCapacity" class="border rounded-xl p-3" type="number" min="4" value="14"/>
            <input id="tripPrice" class="border rounded-xl p-3" type="number" min="0" value="600" />
          </div>
          <button id="saveTrip" class="btn btn-primary mt-3">Save Trip</button>
        </div>

        <div class="card">
          <h3 class="text-lg font-bold mb-3">Assign Driver to Trip</h3>
          <div class="grid md:grid-cols-3 gap-3">
            <select id="assignTrip" class="border rounded-xl p-3"></select>
            <select id="assignDriver" class="border rounded-xl p-3"></select>
            <button id="doAssign" class="btn btn-primary">Assign</button>
          </div>
        </div>

        <div class="card">
          <h3 class="text-lg font-bold mb-3">Passenger Manifest</h3>
          <div class="flex gap-3">
            <select id="manifestTrip" class="border rounded-xl p-3"></select>
            <button id="loadManifest" class="btn btn-primary">Load</button>
          </div>
          <div id="adminManifest" class="mt-3 text-sm"></div>
        </div>

        <div class="card lg:col-span-2">
          <h3 class="text-lg font-bold mb-3">Ops Dashboard</h3>
          <div id="opsSummary" class="text-sm text-gray-700"></div>
          <div id="opsRoutes" class="grid md:grid-cols-3 gap-3 mt-3"></div>
          <button id="opsRefresh" class="border rounded-xl px-3 py-2 mt-3">Refresh</button>
        </div>
      </section>

      <footer class="text-center text-sm text-gray-500 mt-6">© <span id="year"></span> PlateauConnect</footer>
    </div>
  </main>

<script>
const API = { mode: localStorage.getItem('pc_api_mode') || 'local', base: localStorage.getItem('pc_api_base') || '' };
const apiMode = document.getElementById('apiMode'); const apiBase = document.getElementById('apiBase'); const saveApi = document.getElementById('saveApi');
if(apiMode){ apiMode.value = API.mode; apiBase.value = API.base; saveApi.addEventListener('click', ()=>{ localStorage.setItem('pc_api_mode', apiMode.value); localStorage.setItem('pc_api_base', apiBase.value); alert('Saved. Reloading...'); location.reload(); }); }
const storeKey='pc_data_v1', demoTimes=['07:00','08:00','10:00','12:00','14:00','15:00','16:00'];
function loadData(){ const raw=localStorage.getItem(storeKey); if(raw) return JSON.parse(raw); const uid=()=>crypto.randomUUID();
  const stations=[{id:uid(),name:'Terminus Hub',lga:'Jos North',lat:9.9286,lng:8.8925},{id:uid(),name:'Rayfield Park',lga:'Jos South',lat:9.8129,lng:8.8767},{id:uid(),name:'Bukuru Central',lga:'Jos South',lat:9.7938,lng:8.8649},{id:uid(),name:'Miango Junction',lga:'Bassa',lat:9.8510,lng:8.7445},{id:uid(),name:'Pankshin Station',lga:'Pankshin',lat:9.3263,lng:9.4352},{id:uid(),name:'Langtang Park',lga:'Langtang North',lat:9.1356,lng:9.7417}];
  const routes=[{id:uid(),name:'Jos North → Bukuru Central',from:stations[0].id,to:stations[2].id},{id:uid(),name:'Rayfield → Miango Junction',from:stations[1].id,to:stations[3].id},{id:uid(),name:'Jos → Pankshin',from:stations[0].id,to:stations[4].id},{id:uid(),name:'Jos → Langtang',from:stations[0].id,to:stations[5].id}];
  const trips=[]; for(const r of routes){ for(const t of demoTimes){ trips.push({id:uid(),route_id:r.id,time:t,capacity:14,price:(/Langtang|Pankshin/.test(r.name)?1200:600),active:true,driver_id:null}); } }
  const users=[{id:uid(),email:'admin@demo.local',name:'Admin',role:'admin',pass:'admin123'},{id:uid(),email:'rider@demo.local',name:'Rider One',role:'rider',pass:'rider123'},{id:uid(),email:'driver@demo.local',name:'Driver One',role:'driver',pass:'driver123'}];
  const data={stations,routes,trips,users,bookings:[],notifications:[]}; localStorage.setItem(storeKey, JSON.stringify(data)); return data; }
let DB=loadData(); function save(){ localStorage.setItem(storeKey, JSON.stringify(DB)); }
async function apiGet(path,headers={}){ const r=await fetch(API.base+path,{headers}); if(!r.ok) throw new Error('Request failed'); return r.json(); }
async function apiPost(path,body,headers={}){ const r=await fetch(API.base+path,{method:'POST', headers:{'Content-Type':'application/json',...headers}, body:JSON.stringify(body)}); if(!r.ok) throw new Error('Request failed'); return r.json(); }
let currentUser=null; function login(email,pass){ if(API.mode==='live'){ return apiPost('/auth/login',{email,password:pass}).then(d=>{localStorage.setItem('pc_token',d.token); currentUser=d.user; localStorage.setItem('pc_me', JSON.stringify(currentUser));}); } else { const u=DB.users.find(x=>x.email.toLowerCase()===email.toLowerCase()&&x.pass===pass); if(!u) throw new Error('Invalid credentials'); currentUser={...u}; localStorage.setItem('pc_me', JSON.stringify(currentUser)); } }
function register(name,email,pass){ if(API.mode==='live'){ return apiPost('/auth/register',{name,email,password:pass}).then(d=>{localStorage.setItem('pc_token',d.token); currentUser=d.user; localStorage.setItem('pc_me', JSON.stringify(currentUser));}); } else { if(DB.users.some(x=>x.email.toLowerCase()===email.toLowerCase())) throw new Error('Email exists'); const u={id:crypto.randomUUID(),email:email.toLowerCase(),name,role:'rider',pass}; DB.users.push(u); save(); currentUser={...u}; localStorage.setItem('pc_me', JSON.stringify(currentUser)); } }
function me(){ if(!currentUser){ const raw=localStorage.getItem('pc_me'); if(raw) currentUser=JSON.parse(raw);} return currentUser; } function logout(){ currentUser=null; localStorage.removeItem('pc_me'); localStorage.removeItem('pc_token'); }
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const roleSelect=$('#roleSelect'), logoutBtn=$('#logoutBtn'), authView=$('#authView'), appView=$('#appView'), riderDash=$('#riderDash'), driverDash=$('#driverDash'), adminDash=$('#adminDash'); document.getElementById('year').textContent=new Date().getFullYear();
function show(view){ riderDash.classList.add('hidden'); driverDash.classList.add('hidden'); adminDash.classList.add('hidden'); authView.classList.add('hidden'); appView.classList.remove('hidden'); if(view==='rider') riderDash.classList.remove('hidden'); if(view==='driver') driverDash.classList.remove('hidden'); if(view==='admin') adminDash.classList.remove('hidden'); }
function showAuth(){ appView.classList.add('hidden'); authView.classList.remove('hidden'); }
let isLogin=true; const authTitle=$('#authTitle'), authName=$('#authName'), authEmail=$('#authEmail'), authPassword=$('#authPassword'), authSubmit=$('#authSubmit'), authToggle=$('#authToggle');
function renderAuth(){ authTitle.textContent=isLogin?'Sign in':'Create your account'; authName.classList.toggle('hidden',isLogin); authSubmit.textContent=isLogin?'Sign in':'Create account'; authToggle.innerHTML=isLogin?'No account? <button class="text-[color:var(--brand-green)] font-semibold">Register</button>':'Already have an account? <button class="text-[color:var(--brand-green)] font-semibold">Login</button>'; }
if(authToggle){ authToggle.addEventListener('click', ()=>{ isLogin=!isLogin; renderAuth(); }); authSubmit.addEventListener('click', async ()=>{ try{ if(isLogin) await login(authEmail.value, authPassword.value); else await register(authName.value, authEmail.value, authPassword.value); initApp(); }catch(e){ alert(e.message); } }); }
if(logoutBtn){ logoutBtn.addEventListener('click', ()=>{ logout(); initApp(); }); }
function authHeaders(){ const t=localStorage.getItem('pc_token'); return t ? { Authorization:'Bearer '+t } : {}; }
async function listStations(){ return API.mode==='live' ? apiGet('/stations') : DB.stations.slice().sort((a,b)=>a.name.localeCompare(b.name)); }
async function listRoutes(){ if(API.mode==='live'){ return apiGet('/routes'); } else { return DB.routes.map(r=>({...r, from_name: DB.stations.find(s=>s.id===r.from)?.name, to_name: DB.stations.find(s=>s.id===r.to)?.name})); } }
async function listTrips(route_id){ if(API.mode==='live'){ const q=route_id?('?route_id='+route_id):''; return apiGet('/trips'+q); } else { return DB.trips.filter(t=>t.active&&(!route_id||t.route_id===route_id)).sort((a,b)=>a.time.localeCompare(b.time)); } }
async function createBooking(user_id, trip_id, seats){ if(API.mode==='live'){ return apiPost('/bookings',{trip_id,seats},authHeaders()); } const bSeats=DB.bookings.filter(b=>b.trip_id===trip_id&&b.status==='confirmed').reduce((s,b)=>s+b.seats,0); const trip=DB.trips.find(t=>t.id===trip_id); if(!trip) throw new Error('Trip not found'); if(bSeats+seats>trip.capacity) throw new Error('Not enough seats available'); const id=crypto.randomUUID(); DB.bookings.push({id,user_id,trip_id,seats,status:'confirmed',paid:0,payment_ref:null,created_at:new Date().toISOString()}); save(); return {id}; }
async function myBookings(user_id){ if(API.mode==='live'){ return apiGet('/bookings/me',authHeaders()); }
  return DB.bookings.filter(b=>b.user_id===user_id&&b.status==='confirmed').map(b=>{ const t=DB.trips.find(t=>t.id===b.trip_id); const r=DB.routes.find(r=>r.id===t.route_id); return {...b, departure_time:t.time, price:t.price, route_name:r?.name||''}; }).sort((a,b)=>b.created_at.localeCompare(a.created_at)); }
async function payBooking(booking_id){ if(API.mode==='live'){ const provider='paystack'; const data=await apiPost('/payments/initiate',{booking_id,provider},authHeaders()); if(data.authorization_url) window.open(data.authorization_url,'_blank'); const started=Date.now(); while(Date.now()-started<120000){ await new Promise(r=>setTimeout(r,3000)); try{ const v=await apiGet(`/payments/verify/${provider}/${data.reference}`); if(v.paid) return true; }catch(e){} } return false; } else { const b=DB.bookings.find(x=>x.id===booking_id); if(!b) throw new Error('Not found'); b.paid=1; b.payment_ref='DEMO-'+Date.now(); save(); return true; } }
async function assignDriver(trip_id, driver_id){ if(API.mode==='live'){ return apiPost(`/admin/trips/${trip_id}/assign-driver`,{driver_id},authHeaders()); } else { const t=DB.trips.find(x=>x.id===trip_id); if(!t) throw new Error('Trip not found'); const d=DB.users.find(x=>x.id===driver_id&&x.role==='driver'); if(!d) throw new Error('Invalid driver'); t.driver_id=driver_id; save(); } }
async function driverTrips(driver_id){ if(API.mode==='live'){ return apiGet('/driver/my-trips',authHeaders()); } else { return DB.trips.filter(t=>t.driver_id===driver_id).sort((a,b)=>a.time.localeCompare(b.time)); } }
async function tripManifest(trip_id){ if(API.mode==='live'){ return apiGet(`/trips/${trip_id}/manifest`,authHeaders()); } else { return DB.bookings.filter(b=>b.trip_id===trip_id&&b.status==='confirmed').map(b=>{const u=DB.users.find(u=>u.id===b.user_id); const t=DB.trips.find(t=>t.id===b.trip_id); return {booking_id:b.id,name:u?.name||'',email:u?.email||'',seats:b.seats,paid:b.paid,payment_ref:b.payment_ref,time:t.time};}); } }
async function opsMetrics(){ if(API.mode==='live'){ return apiGet('/ops/metrics',authHeaders()); } const byRoute=DB.routes.map(r=>{ const trips=DB.trips.filter(t=>t.route_id===r.id&&t.active); const cap=trips.reduce((s,t)=>s+t.capacity,0); const booked=DB.bookings.filter(b=>trips.some(t=>t.id===b.trip_id)&&b.status==='confirmed').reduce((s,b)=>s+b.seats,0); const revenue=DB.bookings.filter(b=>trips.some(t=>t.id===b.trip_id)&&b.paid===1).reduce((s,b)=>{const t=DB.trips.find(t=>t.id===b.trip_id); return s+(t?.price||0)*b.seats;},0); return {route_name:r.name, utilization_ratio: cap? booked/cap : 0, revenue}; }).sort((a,b)=>b.revenue-a.revenue); return { by_route: byRoute, on_time_rate: 0.95 }; }
const routeSelect=$('#routeSelect'), tripSelect=$('#tripSelect'), seatInput=$('#seatInput'), bookBtn=$('#bookBtn'), myBookingsEl=$('#myBookings'), alertsEl=$('#alerts');
async function loadRoutes(){ const routes=await listRoutes(); routeSelect.innerHTML='<option value="">All routes</option>'+routes.map(r=>`<option value="${r.id}">${r.name}</option>`).join(''); await loadTrips(); }
async function loadTrips(){ const rid=routeSelect.value||''; const trips=await listTrips(rid); tripSelect.innerHTML='<option value="">Departure time</option>'+trips.map(t=>`<option value="${t.id}">${t.time||t.departure_time}</option>`).join(''); }
routeSelect.addEventListener('change', loadTrips);
bookBtn.addEventListener('click', async ()=>{ try{ const tid=tripSelect.value; const seats=Number(seatInput.value||1); if(!tid) return alert('Pick a departure time'); await createBooking(me()?.id, tid, seats); alert('Booking confirmed'); await renderMyBookings(); }catch(e){ alert(e.message); } });
async function renderMyBookings(){ const list=await myBookings(me()?.id); myBookingsEl.innerHTML=list.map(b=>`<div class="border rounded-xl p-3"><div class="font-semibold">${b.route_name}</div><div class="text-gray-600">Departs ${b.departure_time||b.time} • Seats ${b.seats} • ₦${b.price}</div><div class="mt-2 flex gap-2">${b.paid?'<span class="px-2 py-1 rounded bg-green-100 text-green-700">Paid</span>':`<button data-id="${b.id}" class="pay border rounded px-2 py-1">Pay</button>`}</div></div>`).join(''); $$('.pay').forEach(btn=>btn.addEventListener('click', async (e)=>{ const id=e.target.getAttribute('data-id'); try{ const ok=await payBooking(id); await renderMyBookings(); alert(ok?'Payment verified':'Payment pending – refresh later'); }catch(err){ alert(err.message); } })); }
function startAlerts(){ if(typeof Notification!=='undefined'&&Notification.permission==='default'){ const allow=document.createElement('div'); allow.className='mb-4 card'; allow.innerHTML='Allow notifications to get 10-minute departure alerts. <button class="px-2 py-1 border rounded">Allow</button>'; document.querySelector('main').prepend(allow); allow.querySelector('button').onclick=()=>Notification.requestPermission().then(()=>allow.remove()); }
  setInterval(async ()=>{ const u=me(); if(!u) return; const list=await myBookings(u.id); const now=new Date(); list.forEach(b=>{ const tstr=b.departure_time||b.time; if(!tstr) return; const [h,m]=tstr.split(':').map(Number); const t=new Date(); t.setHours(h,m,0,0); const diff=Math.round((t-now)/60000); if(diff===10){ try{ new Notification(`Departing in 10 min: ${b.route_name} @ ${tstr}`); }catch{} alertsEl.textContent=`Departing in 10 min: ${b.route_name} @ ${tstr}`; } }); }, 60000); }
let map; async function renderMap(){ if(map) return; map=L.map('map').setView([9.8965,8.8583],9); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map); (await listStations()).forEach(s=>{ L.marker([s.lat||9.9, s.lng||8.85]).addTo(map).bindPopup(`<b>${s.name}</b><br/><span class="text-xs">${s.lga||''}</span>`); }); }
const driverTripsEl=$('#driverTrips'), driverTripSelect=$('#driverTripSelect'), driverLoadManifestBtn=$('#driverLoadManifest'), driverManifestEl=$('#driverManifest');
async function renderDriver(){ const u=me(); const trips=await driverTrips(u?.id); driverTripsEl.innerHTML=trips.length?('<ul class="list-disc ml-5">'+trips.map(t=>`<li>${(t.time||t.departure_time)} • Trip ${(t.id||'').slice(0,6)}…</li>`).join('')+'</ul>'):'No trips assigned'; driverTripSelect.innerHTML='<option value="">Select trip</option>'+trips.map(t=>`<option value="${t.id}">${t.time||t.departure_time}</option>`).join(''); }
driverLoadManifestBtn.addEventListener('click', async ()=>{ const id=driverTripSelect.value; if(!id) return; const manifest=await tripManifest(id); driverManifestEl.innerHTML=manifest.length?('<ul class="space-y-2">'+manifest.map(m=>`<li class="border rounded-xl p-2"><div class="font-semibold">${m.name} (${m.email})</div><div>Seats ${m.seats} • ${m.paid?'Paid':'Unpaid'}</div></li>`).join('')+'</ul>'):'<div class="text-gray-600">No bookings</div>'; });
const routeName=$('#routeName'), fromStation=$('#fromStation'), toStation=$('#toStation'), saveRoute=$('#saveRoute'), tripRoute=$('#tripRoute'), tripTime=$('#tripTime'), tripCapacity=$('#tripCapacity'), tripPrice=$('#tripPrice'), saveTrip=$('#saveTrip'), assignTrip=$('#assignTrip'), assignDriverSel=$('#assignDriver'), doAssign=$('#doAssign'), manifestTrip=$('#manifestTrip'), loadManifestBtn=$('#loadManifest'), adminManifest=$('#adminManifest'), opsSummary=$('#opsSummary'), opsRoutes=$('#opsRoutes'), opsRefresh=$('#opsRefresh');
async function loadAdminData(){ const st=await listStations(); fromStation.innerHTML='<option value="">From station</option>'+st.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); toStation.innerHTML='<option value="">To station</option>'+st.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); const routes=await listRoutes(); tripRoute.innerHTML='<option value="">Route</option>'+routes.map(r=>`<option value="${r.id}">${r.name}</option>`).join(''); const trips=await listTrips(); assignTrip.innerHTML='<option value="">Trip (by time)</option>'+trips.map(t=>`<option value="${t.id}">${t.time||t.departure_time} • ${t.route_id.slice(0,6)}…</option>`).join(''); manifestTrip.innerHTML='<option value="">Select trip</option>'+trips.map(t=>`<option value="${t.id}">${t.time||t.departure_time}</option>`).join(''); if(API.mode==='live'){ const drivers=await apiGet('/admin/users?role=driver', authHeaders()); assignDriverSel.innerHTML='<option value="">Driver</option>'+drivers.map(d=>`<option value="${d.id}">${d.name||d.email}</option>`).join(''); } else { const drivers=DB.users.filter(u=>u.role==='driver'); assignDriverSel.innerHTML='<option value="">Driver</option>'+drivers.map(d=>`<option value="${d.id}">${d.name} (${d.email})</option>`).join(''); } }
saveRoute.addEventListener('click', async ()=>{ if(!routeName.value||!fromStation.value||!toStation.value) return alert('Fill all route fields'); if(API.mode==='live'){ await apiPost('/admin/routes',{name:routeName.value,from_station_id:fromStation.value,to_station_id:toStation.value},authHeaders()); } else { DB.routes.push({id:crypto.randomUUID(),name:routeName.value,from:fromStation.value,to:toStation.value}); save(); } routeName.value=''; fromStation.value=''; toStation.value=''; await loadAdminData(); alert('Route saved'); });
saveTrip.addEventListener('click', async ()=>{ if(!tripRoute.value) return alert('Pick a route'); if(API.mode==='live'){ await apiPost('/admin/trips',{route_id:tripRoute.value,departure_time:tripTime.value,capacity:Number(tripCapacity.value||14),price:Number(tripPrice.value||0)},authHeaders()); } else { DB.trips.push({id:crypto.randomUUID(),route_id:tripRoute.value,time:tripTime.value,capacity:Number(tripCapacity.value||14),price:Number(tripPrice.value||0),active:true,driver_id:null}); save(); } await loadAdminData(); alert('Trip saved'); });
doAssign.addEventListener('click', async ()=>{ if(!assignTrip.value||!assignDriverSel.value) return alert('Pick trip & driver'); try{ await assignDriver(assignTrip.value, assignDriverSel.value); alert('Driver assigned'); }catch(e){ alert(e.message); } await loadAdminData(); });
loadManifestBtn.addEventListener('click', async ()=>{ if(!manifestTrip.value) return; const list=await tripManifest(manifestTrip.value); adminManifest.innerHTML=list.length? list.map(m=>`<div class="border rounded-xl p-2 mb-2"><div class="font-semibold">${m.name} (${m.email})</div><div>Seats ${m.seats} • ${m.paid?'Paid':'Unpaid'} ${m.payment_ref?('• '+m.payment_ref):''}</div></div>`).join('') : '<div class="text-gray-600">No bookings</div>'; });
async function renderOps(){ const m=await opsMetrics(); opsSummary.textContent=`On-time rate (est.): ${(m.on_time_rate*100).toFixed(0)}%`; opsRoutes.innerHTML=m.by_route.map(r=>`<div class="border rounded-xl p-3"><div class="font-semibold">${r.route_name}</div><div>Utilization: ${(r.utilization_ratio*100).toFixed(0)}%</div><div>Revenue: ₦${r.revenue}</div></div>`).join(''); }
opsRefresh.addEventListener('click', renderOps);
roleSelect.addEventListener('change', async ()=>{ const role=roleSelect.value; if(role==='rider'){ show('rider'); await renderMap(); await renderMyBookings(); } if(role==='driver'){ show('driver'); await renderDriver(); } if(role==='admin'){ show('admin'); await loadAdminData(); await renderOps(); } });
function initApp(){ const u=me(); const apiSpan=document.createElement('div'); apiSpan.className='text-xs text-gray-500 text-center my-2'; apiSpan.innerText=API.mode==='live'?`Live backend: ${API.base}`:'Local Demo mode (no server required)'; document.querySelector('main').prepend(apiSpan); if(!u){ showAuth(); renderAuth(); return; } appView.classList.remove('hidden'); authView.classList.add('hidden'); roleSelect.value=u.role; if(u.role==='rider'){ show('rider'); renderMap(); loadRoutes(); renderMyBookings(); startAlerts(); } if(u.role==='driver'){ show('driver'); renderDriver(); } if(u.role==='admin'){ show('admin'); loadAdminData(); renderOps(); } }
window.addEventListener('load', initApp);
</script>
</body>
</html>
